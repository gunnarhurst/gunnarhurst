name: Update Language Table (LOC Ratio)

on:
  schedule:
    - cron: "0 12 * * *"   # runs daily at 7:00 AM Central
  workflow_dispatch:

permissions:
  contents: write

jobs:
  loc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cloc jq

      - name: Auth GH CLI
        env:
          PAT: ${{ secrets.GH_PRIVATE_TOKEN }}
        run: |
          echo "${PAT}" | gh auth login --with-token

      - name: Fetch repo list (public + private, no forks/archived)
        env:
          PAT: ${{ secrets.GH_PRIVATE_TOKEN }}
        run: |
          gh repo list gunnarhurst --limit 40 --json name,visibility,isFork,isArchived,pushedAt,defaultBranchRef > repos.json
          jq '[ .[] | select((.isFork|not) and (.isArchived|not)) | .name ]' repos.json > names.json
          mkdir -p repos
          for n in $(jq -r '.[]' names.json | head -n 20); do
            echo "Cloning $n"
            git clone --depth 1 "https://${PAT}:x-oauth-basic@github.com/gunnarhurst/$n.git" "repos/$n" || true
          done

      - name: Run CLOC across repos
        run: |
          cloc repos --json --quiet --exclude-dir=node_modules,dist,build,bin,obj,.git > cloc.json || echo '{"header":{},"SUM":{"code":0}}' > cloc.json
          cat cloc.json

      - name: Build LOC ratio table and update README
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const cloc = JSON.parse(fs.readFileSync('cloc.json','utf8'));
          const entries = Object.entries(cloc)
            .filter(([k,v]) => k !== 'header' && k !== 'SUM' && v && typeof v.code === 'number')
            .map(([lang, stats]) => ({ lang, code: stats.code }))
            .filter(e => e.code > 0);

          const total = entries.reduce((a,b)=>a+b.code,0);
          const sorted = entries.sort((a,b)=>b.code - a.code).slice(0, 12);
          const percent = x => (x/total*100);

          const emo = (l) => {
